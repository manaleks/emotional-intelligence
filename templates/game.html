<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <title>Space invaders</title>
    <meta charset="UTF-8">

    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            background-color: black;
            overflow: hidden;
        }

        .space-container {
            background-color: black;
        }

        .row {
            display: flex;
            flex-wrap: nowrap;
        }

        .cell {
            width: 15px;
            height: 15px;
            /* border: rebeccapurple solid 1px;*/
        }
    </style>
</head>

<body>
    <div id="space" class="space-container">
    </div>

    <audio id='background_music' class='audio' style='visibility:hidden;' controls>
            <source src="{{ url_for('static', filename='invaders_must_die.mp3') }}" type="audio/mpeg">
    </audio>

    <script>
        // Create space
        var space = document.getElementById("space");
        var row_len = 102//Math.round(screen.width / 15);
        var column_len = 50//Math.round(screen.height / 15);

        // Game global vars

        // Defender vars
        var def_column = Math.round(column_len / 2);
        var def_row = Math.round(row_len / 2);
        var def_size = 4;
        var def_color = 'white';
        // defender inertia
        var up_last_dir = '';
        var left_last_dir = '';
        var def_inertia_power_max = 1 / 1000;
        var up_def_inertia_power = 30;
        var left_def_inertia_power = 30;
        var RightInertiaInterval;
        var LeftInertiaInterval;
        var UpInertiaInterval;
        var DownInertiaInterval;

        // gun vars
        var gun_sound_numder_all = 0;
        var gun_sound_numder = gun_sound_numder_all;
        var gun_shots_all = 20;
        var gun_shots = gun_shots_all;
        for (var sound_num = gun_sound_numder_all; sound_num < gun_shots_all; sound_num++) {
            var gun_sound = document.createElement("audio");
            gun_sound.setAttribute("id", "gun_attack" + sound_num);
            var gun_sound_src = document.createElement("source");
            gun_sound_src.setAttribute("src", "{{ url_for('static', filename='gun_attack.wav') }}");
            gun_sound_src.setAttribute("type", "audio/wav")
            gun_sound.appendChild(gun_sound_src);
            space.appendChild(gun_sound);
        }


        for (var i = 0; i < column_len; i++) {
            var row = document.createElement("div");
            row.setAttribute('class', 'row')
            row.setAttribute("y", i);
            row.setAttribute("id", i);

            for (var j = 0; j < row_len; j++) {
                var cell = document.createElement("div");
                cell.setAttribute('class', 'cell')
                cell.setAttribute("y", i);
                cell.setAttribute("x", j);
                row.appendChild(cell);
            }
            space.appendChild(row);
        }

        // this fucntion set defender

        function set_defender(y, x, set_def_size, set_def_color) {
            // if in space
            if (y >= Math.round(column_len / 2) && y < column_len && x >= 0 && x < row_len) {

                // clear space
                var enter_row = document.getElementById(def_column);
                var cells = enter_row.childNodes;
                for (var k = 0; k < cells.length; k++) {
                    if (k >= def_row - def_size && k <= def_row + def_size) {
                        cells[k].style = 'background-color: ' + 'black';
                    }
                }

                // set defender
                var enter_row = document.getElementById(y);
                var cells = enter_row.childNodes;
                for (var k = 0; k < cells.length; k++) {
                    if (k >= x - set_def_size && k <= x + set_def_size) {
                        cells[k].style = 'background-color: ' + set_def_color;
                    }
                }
                // save new defender place
                def_column = y;
                def_row = x;
                def_size = set_def_size;
            }
        }

        function draw_cell(y, x, color) {
            var draw_row = document.getElementById(y);
            var draw_cells = draw_row.childNodes;
            draw_cells[x].style = "background-color: " + color + ';';
        }

        function gun_cooldown() {
            gun_shots++;
        }

        function piu(y, x) {
            if (y >= 0) {
                draw_cell(y, x, 'black');
                draw_cell(y-1, x, 'red');
                setTimeout(function () { piu(y - 1, x); }, 10);
            }
        }

        // keyboard control
        document.body.onkeydown = keyboard_controler;
        function keyboard_controler(event) {
            if (event.type = 'keydown') {
                // gun attack
                if (event.key == ' ') {
                    if (gun_shots > 0) {
                        // play sound
                        if (gun_sound_numder == gun_shots_all) {
                            gun_sound_numder = gun_sound_numder_all;
                        }
                        var gun_sound = document.getElementById("gun_attack" + gun_sound_numder);
                        gun_sound.play();

                        // make visualisation
                        piu(def_column-1, def_row);

                       // gun_pius = setInterval(function () { piu(def_column, def_row); }, 30);

                        // count shots
                        gun_shots--;
                        setTimeout(gun_cooldown, 3000);
                        gun_sound_numder++;
                    }
                }
                // play music
                if (event.key == 'q') {
                    var music = document.getElementById('background_music');
                    music.play();
                }
                // end || stop music
                if (event.key == 'Escape') {
                    var music = document.getElementById('background_music');
                    music.pause();
                }

                if (event.key == 'w' || event.key == 'ArrowUp') {
                    set_defender(def_column - 1, def_row, def_size, def_color);
                    clearInterval(UpInertiaInterval);
                    // inertia diff
                    if (up_last_dir == 'w' && up_def_inertia_power > def_inertia_power_max) {
                        up_def_inertia_power = up_def_inertia_power + 1;
                    }
                    else {
                        //up_def_inertia_power = 50;
                    }
                    UpInertiaInterval = setInterval(function () { set_defender(def_column - 1, def_row, def_size, def_color); }, up_def_inertia_power);
                    up_last_dir = 'w';
                }
                if (event.key == 'd' || event.key == 'ArrowRight') {
                    set_defender(def_column, def_row + 1, def_size, def_color);
                    clearInterval(LeftInertiaInterval);
                    if (left_last_dir == 'd' && left_def_inertia_power > def_inertia_power_max) {
                        left_def_inertia_power = left_def_inertia_power + 1;
                    }
                    else {
                        //left_def_inertia_power = 50;
                    }
                    LeftInertiaInterval = setInterval(function () { set_defender(def_column, def_row + 1, def_size, def_color); }, left_def_inertia_power);
                    left_last_dir = 'a';
                }
                if (event.key == 's' || event.key == 'ArrowDown') {
                    set_defender(def_column + 1, def_row, def_size, def_color);
                    clearInterval(UpInertiaInterval);
                    if (up_last_dir == 's' && up_def_inertia_power > def_inertia_power_max) {
                        up_def_inertia_power = up_def_inertia_power + 1;
                    }
                    else {
                        //up_def_inertia_power = 50;
                    }
                    UpInertiaInterval = setInterval(function () { set_defender(def_column + 1, def_row, def_size, def_color); }, up_def_inertia_power);
                    up_last_dir = 's';
                }
                if (event.key == 'a' || event.key == 'ArrowLeft') {
                    set_defender(def_column, def_row - 1, def_size, def_color);
                    clearInterval(LeftInertiaInterval);
                    if (left_last_dir == 'a' && left_def_inertia_power > def_inertia_power_max) {
                        left_def_inertia_power = left_def_inertia_power + 1;
                    }
                    else {
                        //left_def_inertia_power = 50;
                    }
                    LeftInertiaInterval = setInterval(function () { set_defender(def_column, def_row - 1, def_size, def_color); }, left_def_inertia_power);
                    left_last_dir = 'a';
                }
            }
        }
    </script>
</body>

</html>